# OpenCode Centralized Deployment

This project manages the shared opencode deployment for the LCLS team.

## Deployed Directory Structure

All shared files live under `/sdf/group/lcls/ds/dm/apps/`:

| Path | Owner | Purpose |
|------|-------|---------|
| `etc/key.dat` | IT | API key (read-only for employees) |
| `dev/bin/uv` | You | Shared uv binary (for lcls-catalog, tree-sitter-db, etc.) |
| `dev/opencode/opencode.json` | You | Shared config (provider, models) |
| `dev/opencode/agents/*.md` | You | Agent definitions |
| `dev/opencode/skills/lcls-catalog/` | You | lcls-catalog skill |
| `dev/opencode/skills/askcode/` | You | askcode skill (code indexing) |
| `dev/opencode/skills/ask-lcls2/` | You | ask-lcls2 skill (lcls2/psana2 codebase) |
| `dev/opencode/skills/ask-smalldata/` | You | ask-smalldata skill (smalldata_tools codebase) |
| `dev/software/lcls2/` | You | lcls2 git repo with .agent_docs and .code-index.db |
| `dev/software/smalldata_tools/` | You | smalldata_tools git repo with .agent_docs and .code-index.db |
| `dev/data/confluence-doc/lcls-docs.db` | You | Confluence docs SQLite DB |
| `dev/data/daq-logs/daq_logs.db` | You | DAQ error logs SQLite DB |
| `dev/data/lcls-catalog/lcls_parquet/` | You | Catalog parquet files |
| `dev/data/elog-copilot/elog-copilot.db` | You | Elog experiment SQLite DB (~1.3G, symlink to latest) |
| `dev/data/smartsheet/closeout_notes.db` | You | Smartsheet experiment closeout SQLite DB |
| `dev/tools/confluence-doc/` | You | Confluence export pipeline (git repo) |
| `dev/tools/lcls-catalog/` | You | lcls-catalog uv project |
| `dev/tools/daq-logs/` | You | DAQ log sync scripts (git clone) |
| `dev/tools/elog-copilot/` | You | elogfetch uv project |
| `dev/tools/smartsheet/` | You | Smartsheet closeout sync scripts (git clone) |
| `dev/tools/tree-sitter-db/` | You | Code indexing tool (uv project) |

Employees set `OPENCODE_CONFIG_DIR=/sdf/group/lcls/ds/dm/apps/dev/opencode` to use this.

## Source → Deploy Mapping

Deployed files are copies (not symlinks) from these source projects:

| Deployed file | Source |
|---------------|--------|
| `agents/elog-copilot.md` | `/sdf/data/lcls/ds/prj/prjdat21/results/cwang31/elog-copilot-skills/.opencode/agents/elog-copilot.md` |
| `agents/daq-logs.md` | `/sdf/data/lcls/ds/prj/prjcwang31/results/proj-debug-daq/.opencode/agents/daq-logs.md` |
| `agents/confluence-doc.md` | `/sdf/data/lcls/ds/prj/prjdat21/results/cwang31/proj-confluence-llm/.opencode/agents/confluence-doc.md` |
| `skills/lcls-catalog/` | `/sdf/scratch/users/c/cwang31/proj-lcls-catalog/.opencode/skills/lcls-catalog/` |
| `data/confluence-doc/lcls-docs.db` | Cron job via `tools/confluence-doc/scripts/confluence-cron.sh` (every hour on sdfcron001) |
| `tools/confluence-doc/` | `/sdf/data/lcls/ds/prj/prjdat21/results/cwang31/proj-confluence-llm/` (minimal file set, git repo) |
| `data/daq-logs/daq_logs.db` | Cron job via `tools/daq-logs/scripts/run_daq_log_sync.sh` (every 5 min on sdfcron001) |
| `tools/daq-logs/` | `git@github.com:carbonscott/lcls-daq-browser-indexing-scripts.git` |
| `data/lcls-catalog/lcls_parquet/` | `/sdf/data/lcls/ds/prj/prjdat21/results/cwang31/lcls_parquet/` |
| `tools/lcls-catalog/` | `/sdf/scratch/users/c/cwang31/proj-lcls-catalog/` |
| `tools/elog-copilot/` | `/sdf/data/lcls/ds/prj/prjcwang31/results/fetch-elog/` |
| `data/elog-copilot/elog-copilot.db` | Generated by elogfetch cron job (every 6h on sdfcron001) |
| `agents/smartsheet.md` | Authored directly in deployed copy |
| `tools/smartsheet/` | `git@github.com:carbonscott/smartsheet-db-scripts.git` |
| `data/smartsheet/closeout_notes.db` | Cron job via `tools/smartsheet/scripts/smartsheet-cron.sh` (daily on sdfcron001) |
| `skills/askcode/` | Authored directly in deployed copy |
| `tools/tree-sitter-db/` | `/sdf/data/lcls/ds/prj/prjdat21/results/cwang31/fun/play-tree-sitter/tree-sitter-db/` |
| `software/lcls2/` | `git@github.com:slac-lcls/lcls2.git` (full clone) |
| `software/lcls2/.agent_docs/` | `/sdf/data/lcls/ds/prj/prjcwang31/results/software/lcls2/.agent_docs/` |
| `software/lcls2/.code-index.db` | `/sdf/data/lcls/ds/prj/prjcwang31/results/software/lcls2/.code-index.db` |
| `software/smalldata_tools/` | `git@github.com:slac-lcls/smalldata_tools.git` (full clone) |
| `software/smalldata_tools/.agent_docs/` | `/sdf/data/lcls/ds/prj/prjcwang31/results/software/smalldata_tools/.agent_docs/` |
| `software/smalldata_tools/.code-index.db` | `/sdf/data/lcls/ds/prj/prjcwang31/results/software/smalldata_tools/.code-index.db` |
| `skills/ask-lcls2/` | Authored directly in deployed copy |
| `skills/ask-smalldata/` | Authored directly in deployed copy |

When copying agents/skills, hardcoded paths must be updated to the shared locations.

## Updating Deployed Data

```bash
# Confluence docs DB — managed by cron (every hour via tools/confluence-doc/scripts/confluence-cron.sh)
# No manual copy needed. To check status:
#   /sdf/group/lcls/ds/dm/apps/dev/tools/confluence-doc/scripts/confluence-cron.sh status

# DAQ logs DB — managed by cron (every 5 min via tools/daq-logs/scripts/sync-cron.sh)
# No manual copy needed. To check status:
#   /sdf/group/lcls/ds/dm/apps/dev/tools/daq-logs/scripts/sync-cron.sh status

# Parquet catalog data (5.9G)
rsync -a --exclude='.uv-cache' \
   /sdf/data/lcls/ds/prj/prjdat21/results/cwang31/lcls_parquet/ \
   /sdf/group/lcls/ds/dm/apps/dev/data/lcls-catalog/lcls_parquet/

# Smartsheet closeout DB — managed by cron (daily via tools/smartsheet/scripts/smartsheet-cron.sh)
# No manual copy needed. To check status:
#   tail /sdf/group/lcls/ds/dm/apps/dev/data/smartsheet/cron.log
```

## Key Config Details

- `opencode.json` references the API key via `{file:/sdf/group/lcls/ds/dm/apps/etc/key.dat}`
- Config precedence: global user < OPENCODE_CONFIG_DIR < project < OPENCODE_CONFIG_CONTENT
- The `tools/lcls-catalog/env.sh` defines the `lcat` shell function and sets `LCLS_CATALOG_APP_DIR` and `CATALOG_DATA_DIR`
- The `tools/daq-logs/scripts/env.sh` sets `DAQ_LOGS_APP_DIR` and `DAQ_LOGS_DATA_DIR`; cron job runs every 5 min syncing DAQ logs to `data/daq-logs/`
- The `tools/elog-copilot/env.sh` defines `ELOG_COPILOT_APP_DIR` and `ELOG_COPILOT_DATA_DIR`; cron job runs every 6 hours updating `data/elog-copilot/elog-copilot.db`
- The `tools/confluence-doc/env.sh` defines `CONFLUENCE_DOC_APP_DIR` and `CONFLUENCE_DOC_DATA_DIR`; cron job runs every hour exporting Confluence docs to `data/confluence-doc/lcls-docs.db`
- The `tools/smartsheet/env.sh` defines `SMARTSHEET_APP_DIR` and `SMARTSHEET_DATA_DIR`; reads API key from `dev/env/smartsheet.dat`; cron job runs daily syncing closeout data to `data/smartsheet/`
- The `tools/tree-sitter-db/env.sh` defines `TREE_SITTER_DB_APP_DIR` and `TREE_SITTER_DB_DATA_DIR`; provides `tsdb` wrapper for on-demand code indexing (no cron job)
- **Skills need symlinks in agents/ for @invocation**: Opencode loads from `agents/` directory. Skills in `skills/` need symlinks in `agents/` to be invoked with `@skill-name`. Current symlinks: `agents/askcode -> ../skills/askcode`, `agents/lcls-catalog -> ../skills/lcls-catalog`, `agents/ask-lcls2 -> ../skills/ask-lcls2`, `agents/ask-smalldata -> ../skills/ask-smalldata`
- The `software/update-index.sh` script updates git repos and regenerates code indexes: `./update-index.sh [lcls2|smalldata_tools|all]`

## Agent/Skill Config Locations

When modifying an agent or skill, update all copies. Changes in the source are for local development; changes in the deployed copy take effect for all employees.

### lcls-catalog

| Copy | Path |
|------|------|
| Deployed (opencode) | `/sdf/group/lcls/ds/dm/apps/dev/opencode/skills/lcls-catalog/SKILL.md` |
| Source (opencode) | `/sdf/scratch/users/c/cwang31/proj-lcls-catalog/.opencode/skills/lcls-catalog/SKILL.md` |
| Source (claude) | `/sdf/scratch/users/c/cwang31/proj-lcls-catalog/.claude/skills/lcls-catalog/SKILL.md` |

### confluence-doc

| Copy | Path |
|------|------|
| Deployed (opencode agent) | `/sdf/group/lcls/ds/dm/apps/dev/opencode/agents/confluence-doc.md` |
| Source (opencode agent) | `/sdf/data/lcls/ds/prj/prjdat21/results/cwang31/proj-confluence-llm/.opencode/agents/confluence-doc.md` |
| Source (claude skill) | `/sdf/data/lcls/ds/prj/prjdat21/results/cwang31/proj-confluence-llm/.claude/skills/confluence-doc/SKILL.md` |

### elog-copilot

| Copy | Path |
|------|------|
| Deployed (opencode agent) | `/sdf/group/lcls/ds/dm/apps/dev/opencode/agents/elog-copilot.md` |
| Source (opencode agent) | `/sdf/data/lcls/ds/prj/prjdat21/results/cwang31/elog-copilot-skills/.opencode/agents/elog-copilot.md` |
| Source (claude skill) | `/sdf/data/lcls/ds/prj/prjdat21/results/cwang31/elog-copilot-skills/.claude/skills/elog-copilot/SKILL.md` |

### smartsheet

| Copy | Path |
|------|------|
| Deployed (opencode agent) | `/sdf/group/lcls/ds/dm/apps/dev/opencode/agents/smartsheet.md` |

### askcode

| Copy | Path |
|------|------|
| Deployed (opencode skill) | `/sdf/group/lcls/ds/dm/apps/dev/opencode/skills/askcode/SKILL.md` |
| Source (tool) | `/sdf/data/lcls/ds/prj/prjdat21/results/cwang31/fun/play-tree-sitter/tree-sitter-db/` |

### ask-lcls2

| Copy | Path |
|------|------|
| Deployed (opencode skill) | `/sdf/group/lcls/ds/dm/apps/dev/opencode/skills/ask-lcls2/SKILL.md` |
| Software repo | `/sdf/group/lcls/ds/dm/apps/dev/software/lcls2/` |
| Agent docs | `/sdf/group/lcls/ds/dm/apps/dev/software/lcls2/.agent_docs/` |
| Code index | `/sdf/group/lcls/ds/dm/apps/dev/software/lcls2/.code-index.db` |
| Agent docs source | `/sdf/data/lcls/ds/prj/prjcwang31/results/software/lcls2/.agent_docs/` |

### ask-smalldata

| Copy | Path |
|------|------|
| Deployed (opencode skill) | `/sdf/group/lcls/ds/dm/apps/dev/opencode/skills/ask-smalldata/SKILL.md` |
| Software repo | `/sdf/group/lcls/ds/dm/apps/dev/software/smalldata_tools/` |
| Agent docs | `/sdf/group/lcls/ds/dm/apps/dev/software/smalldata_tools/.agent_docs/` |
| Code index | `/sdf/group/lcls/ds/dm/apps/dev/software/smalldata_tools/.code-index.db` |
| Agent docs source | `/sdf/data/lcls/ds/prj/prjcwang31/results/software/smalldata_tools/.agent_docs/` |
